<!DOCTYPE html>
<html>
    <head>
        <link rel="stylesheet" href="style.css">
    </head>
    <body onload="init()">
        <h1 class="main_title">Path tracer</h1>
        <p class="subtitle">Web-based path tracer</p>
        <hr>
        <br>
        <div id="main_content">
            <div>
                <div id="parameters"></div>
                <hr>
                <div class="center flex-column">
                    <div id="bottom_parameters"></div>
                    <button onclick="render()">Render</button>
                    <p id="loading"></p>
                </div>
            </div>
            <canvas id="canvas" width="800" height="800"></canvas>
        </div>
        <hr>
        <div class="explanations">
            <p>This is a very simple path tracer implemented purely in javascript.</p>
            <p>For now it is very limited. Numerous new features are planned. For now it has the following features : </p>
            <ul>
                <li>Handles spheres rendering</li>
                <li>User-defined number of samples per pixels (for now the samples in each pixel have random position)</li>
                <li>Camera with modifiable position and FOV</li>
            </ul>
        </div>
    </body>
    <script src="js/ModelHelper.js"></script>
    <script type="module">
        import Slider from "./js/ui/slider.js"
        import Tabs from "./js/ui/tabs.js"
        import Camera from "./js/camera.js"
        import {Ray, Vec3} from "./js/primitives.js"
        import {Sphere, Triangle} from "./js/objects.js"
        document.Slider = Slider
        document.Tabs   = Tabs
        document.Camera = Camera
        document.Ray = Ray
        document.Vec3 = Vec3
        document.Sphere = Sphere
        document.Triangle = Triangle
    </script>
    <script>
        function init(){
            Slider = document.Slider
            Tabs   = document.Tabs
            Camera = document.Camera
            Ray = document.Ray
            Vec3 = document.Vec3
            Sphere = document.Sphere
            Triangle = document.Triangle

            document.global_params = {
                samples_per_pixel: 5,
                camera:{
                    fov: 45,
                    x:0,
                    y:0,
                    z:0
                }
            }

            let tabs = new Tabs(document.getElementById("parameters"), "main_tabs", ["Camera", "Objects"], "Camera")
            tabs.setContent("Camera", `
                <p>Position</p>
                <div id="camera_position"></div>
                <p>Lens</p>
                <div id="camera_others"></div>
            `)
            tabs.setContent("Objects", `
                <p>-- Tab under construction --</p>
            `)

            new Slider("camera_position", "X", 0,  val=>document.global_params.camera.x=val, -20, 20, 1)
            new Slider("camera_position", "Y", 0,  val=>document.global_params.camera.y=val, -20, 20, 1)
            new Slider("camera_position", "Z", 0,  val=>document.global_params.camera.z=val, -20, 20)
            new Slider("camera_others", "Field of view", 45, val=>document.global_params.camera.fov=val, 5, 170)

            new Slider("bottom_parameters", "Samples per pixel", 5,  val=>document.global_params.samples_per_pixel=val, 1, 50, 1, 0)

            global_objs = [
                //new Sphere( new Vec3(0,0,-4), 1),
                new Sphere( new Vec3(0,-21,-4), 20),

                new Sphere( new Vec3(1.5,  1.5, -5), 0.5),
                new Sphere( new Vec3(-1.5, 1.5, -5), 0.5),

                new Triangle( new Vec3(0.5,0.5,-5), new Vec3(-0.5,0.5,-2), new Vec3(0.5,-0.5,-2) )
            ]

            //render()
        }
 
        function render(){
            const canvas    = document.getElementById("canvas")
            const imageData = canvas.getContext("2d").createImageData(canvas.width, canvas.height)

            const params = document.global_params

            const camera = new Camera(canvas.width/canvas.height, params.camera.fov, new Vec3(params.camera.x, params.camera.y, params.camera.z))


            ModelHelper.loadWavefront("teapot/teapot_simple.obj").then( teapot => {

                console.log(teapot)

                let obj = []
                for(let i=0; i<teapot.faces.length; i++){
                    let p1 = new Vec3(
                        parseFloat(teapot.vertices[teapot.faces[i][0]][0])/5, 
                        parseFloat(teapot.vertices[teapot.faces[i][0]][1])/5, 
                        parseFloat(teapot.vertices[teapot.faces[i][0]][2])/5-7
                    )
                    let p2 = new Vec3(
                        parseFloat(teapot.vertices[teapot.faces[i][1]][0])/5, 
                        parseFloat(teapot.vertices[teapot.faces[i][1]][1])/5, 
                        parseFloat(teapot.vertices[teapot.faces[i][1]][2])/5-7
                    )
                    let p3 = new Vec3(
                        parseFloat(teapot.vertices[teapot.faces[i][2]][0])/5, 
                        parseFloat(teapot.vertices[teapot.faces[i][2]][1])/5, 
                        parseFloat(teapot.vertices[teapot.faces[i][2]][2])/5-7
                    )
                    obj.push(new Triangle(p1, p2, p3))
                }
                console.log(obj)

                let worker = new Worker("js/worker.js", { type: "module" })
                worker.postMessage({
                    width:  imageData.width,
                    height: imageData.height,
                    objs: global_objs,
                    samples_per_pixel: params.samples_per_pixel,
                    camera : camera
                })

                worker.onmessage = (e) => {
                    let result = new ImageData(new Uint8ClampedArray(e.data), imageData.width, imageData.height)
                    canvas.getContext("2d").putImageData(result, 0, 0)
                    console.log("Finished !")
                };
            })
        }
    </script>  
</html>